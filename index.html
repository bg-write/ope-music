<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPE! - Music Reviews by Brady Gerber</title>
    <meta name="description" content="Music sucks.">
    <meta name="keywords" content="music discovery, song of the week, music recommendations, indie music, new music">
    <meta name="author" content="Brady Gerber">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="OPE! - Music Reviews by Brady Gerber">
    <meta property="og:description" content="Music sucks.">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="OPE! - Music Reviews by Brady Gerber">
    <meta name="twitter:description" content="Music sucks.">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
</head>
<body>
    <!-- Skip Navigation Link for Screen Readers -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Header Section with logo and tagline -->
    <!-- Contains the main title, subtitle, and animated logo image -->
    <header class="header-content" role="banner">
        <div class="header-text">
            <h1>OPE!</h1>
            <p>Music reviews by Brady Gerber</p>
            <p>Fueled by corn and spite</p>
        </div>
        <div class="header-image">
            <img src="images/logo.png" alt="OPE! Logo - Animated music note icon" class="logo">
        </div>
    </header>

    <!-- Navigation tabs for switching between different content sections -->
    <!-- Each tab loads content dynamically without page refresh -->
    <nav class="nav" role="navigation" aria-label="Main navigation">
        <a href="#" onclick="showContent('free')" id="free-link" role="tab" aria-selected="true" aria-controls="content-container">Songs</a>
        <a href="#" onclick="showContent('newsletter')" id="newsletter-link" role="tab" aria-selected="false" aria-controls="content-container">Newsletter</a>
        <a href="#" onclick="showContent('podcast')" id="podcast-link" role="tab" aria-selected="false" aria-controls="content-container">Podcast</a>
        <!-- <a href="#" onclick="showContent('email')" id="email-link" role="tab" aria-selected="false" aria-controls="content-container">Email</a> -->
        <!-- <a href="#" onclick="showContent('albums')" id="albums-link" role="tab" aria-selected="false" aria-controls="content-container">Album Reviews</a> -->
        <!-- <a href="#" onclick="showContent('members')" id="members-link" role="tab" aria-selected="false" aria-controls="content-container">Exclusive Member Content</a> -->
    </nav>

    <!-- Content Container - dynamically populated by JavaScript -->
    <!-- Content is loaded from the 'content' object below, which gets updated by build.js -->
    <main id="main-content" role="main" aria-live="polite" aria-label="Page content">
        <div id="content-container">
            <!-- Content will be loaded here dynamically -->
            <p>Content will be loaded from Markdown files...</p>
        </div>
    </main>

    <!-- Floating Back to Top Button -->
    <button id="back-to-top" class="back-to-top-btn" aria-label="Back to top of page" title="Back to top">
        ‚Üë
    </button>

    <script>
        // API Configuration
        const API_BASE = 'https://ope-music.netlify.app/api';
        
        // Global data storage
        let reviewsData = [];
        let linksData = [];
        
        // Content data - Now dynamically populated from API
        let content = {
            free: { title: "Songs", html: '<div class="section"><p>Loading reviews...</p></div>' },
            newsletter: { title: "Newsletter", html: `<div class="section">
        <p>A link to the week's reviews every Friday, along with other "fun" links and "musings" on "life": <a href="https://bradygerber.com/newsletter/" target="_blank" rel="noopener">https://bradygerber.com/newsletter/</a></p>
    </div>` },
            podcast: { title: "Podcast", html: `<div class="section">
        <p>My reviews, but easier to understand: <a href="https://bradygerber.com/podcast-and-youtube/" target="_blank" rel="noopener">https://bradygerber.com/podcast-and-youtube/</a></p>
    </div>` },
            members: { title: "All Weekly Picks", html: '<div class="section"><p>Loading all content...</p></div>' }
        };

        // Function to generate song HTML from API data
        function generateSongHTML(song) {
            return `
            <div class="song-entry" id="${song.review_id}" data-artist="${song.song_artist.toLowerCase()} ${song.song_title.toLowerCase()}">
                <h3 class="song-title">${song.song_artist} - "${song.song_title}"</h3>
                <p class="song-rating">${song.review_score}</p>
                <p class="song-date">${song.review_date}</p>
                <p class="song-description">${song.review_text}</p>
                <div class="song-links">
                    <a href="${song.song_url}" target="_blank" rel="noopener">Listen</a>
                </div>
            </div>`;
        }

        // Function to generate link HTML from API data
        function generateLinkHTML(link) {
            return `
            <div class="link-entry">
                <h3 class="link-title">${link.title}</h3>
                <p class="link-date">${link.date}</p>
                <p class="link-description">${link.description}</p>
                <div class="link-links">
                    <a href="${link.url}" target="_blank" rel="noopener">Read More</a>
                </div>
            </div>`;
        }

        // Function to update content from API data
        function updateContentFromAPI() {
            // Update Songs tab (free)
            if (reviewsData.length > 0) {
                const songsHTML = `
                <div class="section">
                    <div class="search-section">
                        <input type="text" id="song-search" placeholder="Search for artist or song..." onkeyup="searchSongs()">
                        <p class="search-help">Type a song title (e.g., "Like a Rolling Stone") or artist name to search</p>
                    </div>
                    ${reviewsData.map(song => generateSongHTML(song)).join('')}
                </div>`;
                content.free.html = songsHTML;
            }

            // Update All Weekly Picks tab (members)
            if (reviewsData.length > 0 || linksData.length > 0) {
                const membersHTML = `
                <div class="section">
                    <input type="text" id="song-search" placeholder="Search for artist or song..." onkeyup="searchSongs()">
                    <p class="search-help">Type a song title (e.g., "Like a Rolling Stone") or artist name to search</p>
                    ${reviewsData.map(song => generateSongHTML(song)).join('')}
                    ${linksData.map(link => generateLinkHTML(link)).join('')}
                </div>`;
                content.members.html = membersHTML;
            }

            // Update footer date with most recent review date
            if (reviewsData.length > 0) {
                const mostRecentReview = reviewsData[0]; // First review is most recent
                const lastUpdatedSpan = document.getElementById('last-updated-date');
                if (lastUpdatedSpan) {
                    lastUpdatedSpan.textContent = mostRecentReview.review_date;
                }
            }
        }

        // Function to fetch data from API
        async function fetchDataFromAPI() {
            try {
                // Show loading state
                content.free.html = '<div class="section"><p>üîÑ Loading reviews from API...</p></div>';
                content.members.html = '<div class="section"><p>üîÑ Loading all content from API...</p></div>';
                
                // Refresh current tab to show loading
                const currentTab = document.querySelector('.nav a[aria-selected="true"]');
                if (currentTab) {
                    const currentPage = currentTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                    showContent(currentPage);
                }

                // Fetch reviews
                const reviewsResponse = await fetch(`${API_BASE}/reviews`);
                if (!reviewsResponse.ok) {
                    throw new Error(`HTTP ${reviewsResponse.status}: ${reviewsResponse.statusText}`);
                }
                
                const reviewsResult = await reviewsResponse.json();
                reviewsData = reviewsResult.reviews || [];

                linksData = []; // No links API yet

                // Update content with API data
                updateContentFromAPI();

                // If we're on a tab that needs to refresh, refresh it
                if (currentTab) {
                    const currentPage = currentTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                    showContent(currentPage);
                }

                console.log('‚úÖ API data loaded successfully:', { reviews: reviewsData.length, links: linksData.length });
            } catch (error) {
                console.error('‚ùå Error fetching API data:', error);
                // Create error HTML with retry button
                const errorHTML = `<div class="section">
                    <p>‚ùå Error loading reviews: ${error.message}</p>
                    <p><button onclick="fetchDataFromAPI()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ Retry</button></p>
                </div>`;
                
                content.free.html = errorHTML;
                content.members.html = errorHTML;
                
                // Refresh current tab to show error
                const currentTab = document.querySelector('.nav a[aria-selected="true"]');
                if (currentTab) {
                    const currentPage = currentTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                    showContent(currentPage);
                }
            }
        }

        // Function to show content
        function showContent(page) {
            const container = document.getElementById('content-container');
            const freeLink = document.getElementById('free-link');
            const newsletterLink = document.getElementById('newsletter-link');
            const podcastLink = document.getElementById('podcast-link');
            
            // Update content
            container.innerHTML = content[page].html;
            
            // Update navigation styling and ARIA states
            freeLink.classList.remove('active');
            freeLink.setAttribute('aria-selected', 'false');
            newsletterLink.classList.remove('active');
            newsletterLink.setAttribute('aria-selected', 'false');
            podcastLink.classList.remove('active');
            podcastLink.setAttribute('aria-selected', 'false');
            
            if (page === 'free') {
                freeLink.classList.add('active');
                freeLink.setAttribute('aria-selected', 'true');
            } else if (page === 'newsletter') {
                newsletterLink.classList.add('active');
                newsletterLink.setAttribute('aria-selected', 'true');
            } else if (page === 'podcast') {
                podcastLink.classList.add('active');
                podcastLink.setAttribute('aria-selected', 'true');
            }
            
            // Update page title
            document.title = `OPE! - ${content[page].title}`;
            
            // Announce page change to screen readers
            announcePageChange(content[page].title);
        }
        
        // Function to announce page changes to screen readers
        function announcePageChange(pageTitle) {
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = `Switched to ${pageTitle} page`;
            
            document.body.appendChild(announcement);
            
            // Remove after announcement
            setTimeout(() => {
                document.body.removeChild(announcement);
            }, 1000);
        }

        // Function to search songs by artist name or song title
        // Supports multi-term search and shows "no results" message when needed
        function searchSongs() {
            const searchTerm = document.getElementById('song-search').value.toLowerCase();
            const songEntries = document.querySelectorAll('.song-entry[data-artist]');
            let visibleCount = 0;
            
            // Split search into individual terms
            const searchTerms = searchTerm.split(' ').filter(term => term.length > 0);
            
            songEntries.forEach(entry => {
                const artistText = entry.getAttribute('data-artist');
                const titleText = entry.querySelector('.song-title').textContent.toLowerCase();
                const combinedText = `${artistText} ${titleText}`;
                
                let shouldShow = false;
                
                if (searchTerm === '') {
                    // Empty search shows everything
                    shouldShow = true;
                } else if (searchTerms.length === 1) {
                    // Single term search - check if it appears anywhere
                    shouldShow = combinedText.includes(searchTerms[0]);
                } else {
                    // Multi-term search - check if ALL terms appear somewhere
                    shouldShow = searchTerms.every(term => combinedText.includes(term));
                }
                
                if (shouldShow) {
                    entry.style.display = 'block';
                    visibleCount++;
                } else {
                    entry.style.display = 'none';
                }
            });
            
            // Show/hide "no results" message
            let noResultsMsg = document.getElementById('no-results-msg');
            if (!noResultsMsg) {
                noResultsMsg = document.createElement('p');
                noResultsMsg.id = 'no-results-msg';
                noResultsMsg.className = 'no-results';
                noResultsMsg.textContent = 'No results, sad.';
                const searchSection = document.querySelector('.search-section');
                if (searchSection) {
                    searchSection.appendChild(noResultsMsg);
                }
            }
            
            if (visibleCount === 0 && searchTerm !== '') {
                noResultsMsg.style.display = 'block';
            } else {
                noResultsMsg.style.display = 'none';
            }
        }

        // Show free page by default
        document.addEventListener('DOMContentLoaded', function() {
            // Check if there's a hash in the URL for direct navigation
            handleHashNavigation();
            
            // Show default page
            showContent('free');

            // Fetch data from API on load
            fetchDataFromAPI();
        });

        // Function to share a song by copying its direct link to clipboard
        // Creates a unique URL with hash navigation for each song
        function shareSong(songId, songTitle) {
            const currentUrl = window.location.href.split('#')[0];
            const shareUrl = `${currentUrl}#${songId}`;
            
            // Simply copy the direct link to clipboard
            copyToClipboard(songId, songTitle, shareUrl);
        }
        

        
        // Function to copy link to clipboard
        function copyToClipboard(songId, songTitle, shareUrl) {
            const doSuccessUI = () => {
                // Show success message
                const shareBtn = document.querySelector(`#${songId} .share-btn`);
                
                if (shareBtn) {
                    const originalText = shareBtn.textContent;
                    shareBtn.textContent = '‚úÖ Link Copied!';
                    shareBtn.classList.add('copied');
                    
                    setTimeout(() => {
                        shareBtn.textContent = originalText;
                        shareBtn.classList.remove('copied');
                    }, 2000);
                }
            };

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareUrl).then(doSuccessUI).catch(() => {
                    // Fallback below
                    try {
                        const ta = document.createElement('textarea');
                        ta.value = shareUrl;
                        ta.setAttribute('readonly', '');
                        ta.style.position = 'absolute';
                        ta.style.left = '-9999px';
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                        doSuccessUI();
                    } catch (err2) {
                        alert('Link: ' + shareUrl);
                    }
                });
            } else {
                // Fallback for insecure contexts
                try {
                    const ta = document.createElement('textarea');
                    ta.value = shareUrl;
                    ta.setAttribute('readonly', '');
                    ta.style.position = 'absolute';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    doSuccessUI();
                } catch (err3) {
                    alert('Link: ' + shareUrl);
                }
            }
        }
        




        // Function to handle hash navigation
        function handleHashNavigation() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                // All reviews go to the songs tab
                showContent('free');
                
                // Wait for API data to load, then scroll to element
                const waitForElement = () => {
                    const targetElement = document.getElementById(hash);
                    if (targetElement) {
                        // Scroll to element
                        targetElement.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                        
                        // Add a subtle highlight effect
                        targetElement.style.boxShadow = '0 0 20px rgba(0,123,255,0.3)';
                        setTimeout(() => {
                            targetElement.style.boxShadow = '';
                        }, 2000);
                    } else if (reviewsData.length > 0) {
                        // Element should exist now, try again
                        setTimeout(waitForElement, 100);
                    } else {
                        // Still loading, wait longer
                        setTimeout(waitForElement, 500);
                    }
                };
                
                waitForElement();
            }
        }

        // Listen for hash changes
        window.addEventListener('hashchange', handleHashNavigation);

        // Back to top functionality
        const backToTopBtn = document.getElementById('back-to-top');
        
        // Show/hide button based on scroll position
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        });
        
        // Smooth scroll to top when clicked
        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
        
        // Keyboard navigation for tabs
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                const tabs = document.querySelectorAll('.nav a[role="tab"]');
                const currentTab = document.querySelector('.nav a[aria-selected="true"]');
                const currentIndex = Array.from(tabs).indexOf(currentTab);
                
                let nextIndex;
                if (e.key === 'ArrowRight') {
                    nextIndex = (currentIndex + 1) % tabs.length;
                } else {
                    nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                }
                
                const nextTab = tabs[nextIndex];
                const page = nextTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                showContent(page);
                nextTab.focus();
                e.preventDefault();
            }
        });
    </script>

                                                                                                                                                        <!-- Footer -->
<footer class="footer" role="contentinfo">
        
        <div class="footer-content">
            <div class="last-updated">
                <strong>Last updated:</strong> <span id="last-updated-date">Loading...</span> (Los Angeles, CA PST Time)
            </div>
            
            <div class="support-info">
                <strong>Best ways to support:</strong> Bookmark this page, subscribe to the newsletter and podcast, tell all your friends.
            </div>
            
            <div class="contact-info">
                Don't like my reviews? Email me at bradywgerber at gmail dot com to tell me why I'm wrong, or hate-click my <a href="https://bradygerber.com/" target="_blank" rel="noopener">website</a>.
            </div>
            
            <div class="footer-bottom">
                <img src="images/author.png" alt="Brady Gerber" class="author-image">
                <span class="copyright">&copy; 2025 OPE!. All rights reserved.</span>
            </div>
        </div>
    </footer>
</body>
</html>
